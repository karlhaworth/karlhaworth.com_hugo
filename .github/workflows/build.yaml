name: Build for Cloudflare

on:
    push:

jobs:
    build:
        runs-on: ubuntu-latest
        permissions:
          contents: read
          deployments: write
        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - uses: browser-actions/setup-chrome@v1
            - run: chrome --version

            - name: Setup Hugo
              uses: peaceiris/actions-hugo@v2
              with:
                hugo-version: '0.110.0'

            - name: build
              run: make CF_PAGES_URL="https://karlhaworth.com" publish-cloudflare

            - name: Publish
              uses: cloudflare/pages-action@1
              with:
                apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                projectName: 'karlhaworth-com-hugo'
                directory: 'public'
                gitHubToken: ${{ secrets.GITHUB_TOKEN }}
                branch: ${GITHUB_REF#refs/heads/}
